<!DOCTYPE html>
<html>
    <head>
        <script src="./js/jquery.min.js"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        
        <script src="./js/webgazer.js"></script>

        <script src="jspsych.js"></script>
        <script src="plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-eyetracking.js"></script>

        <script src="plugins/jspsych-resize.js"></script>

        <link rel="stylesheet" href="css/jspsych.css">
        <link rel="stylesheet" href="css/jspsych-eyetracking.css">
    </head>
    <body>
    </body>
    <script>
        var timeline = [];

        var consent = {
            type: "html-keyboard-response",
            stimulus: "this is the consent form. press any key"
        };
        timeline.push(consent);

        var inputs = {
            type: 'resize',
            item_width: 8.56,
            item_height: 5.397,
            prompt: "<p>Click and drag the lower right corner of the box until the"+
            " box is the same size as a credit card held up to the screen.</p>",
            pixels_per_unit: 50 /* 50 pixels equals 1 cm */
        };
        timeline.push(inputs);

        var calibration = {
            type: "eye-tracking",
            minimumAccuracy: 0,
            videoOn: true,
            predictionOn: true,
            on_finish: function(trial){
                webgazer.pause();
            }
        };
        timeline.push(calibration);

        var eyeData;
        var eye_tracking_interval;

        var trial = {
            type: "html-keyboard-response",
            stimulus: "this is trial 1. press any key",
            on_start: function(trial) {
                webgazer.resume();
                eyeData = [];
                var starttime = performance.now();
                eye_tracking_interval = setInterval(
                    function() {
                        webgazer.getCurrentPrediction()
                            .then((pos) => {
                                console.log(pos.x)
                                eyeData.push({
                                    'x': pos.x,
                                    'y': pos.y,
                                    'time_elapsed': performance.now() - starttime
                                });
                            });
                    }
                )
            },
            on_finish: function(trial_data){
                webgazer.pause();
                clearInterval(eye_tracking_interval);
                trial_data['eye_data'] = eyeData;
                console.log(trial_data['eye_data']);
            }
        };
        timeline.push(trial);

        var trial = {
            type: "html-keyboard-response",
            stimulus: "this is trial 2. press any key",
            on_start: function(trial) {
                webgazer.resume();
                eyeData = [];
                var starttime = performance.now();
                eye_tracking_interval = setInterval(
                    function() {
                        webgazer.getCurrentPrediction()
                            .then((pos) => {
                                console.log(pos.x)
                                eyeData.push({
                                    'x': pos.x,
                                    'y': pos.y,
                                    'time_elapsed': performance.now() - starttime
                                });
                            });
                    }
                )
            },
            on_finish: function(trial_data){
                webgazer.pause();
                clearInterval(eye_tracking_interval);
                trial_data['eye_data'] = eyeData;
                console.log(trial_data['eye_data']);
            }
        };
        timeline.push(trial);

        // var past50 = webgazer.getStoredPoints(); // retrieve the stored points

        jsPsych.init({
            timeline: timeline,
            on_trial_start: function(trial) {
                console.log('start trial');
            },
            on_trial_finish: function(trial) {
                console.log('stop trial');
            },
            on_finish: function() {
                jsPsych.data.displayData('json');
            }
        });
    </script>
</html>